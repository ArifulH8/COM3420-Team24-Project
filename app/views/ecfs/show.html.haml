= javascript_pack_tag "show_ecf"
- if can? :showECFs, User
  %p= link_to 'Show all ECFs', showECFs_user_path(@ecf.user), class: 'btn btn-primary'

.row.justify-content-center
  .login-wrap.py-5
    - unless current_user.student?
      %h4 Student Details
      .table-responsive
        %table.table
          %thead
            %tr
              %th{:scope => "col"} Username:
              %th{:scope => "col"} First Name:
              %th{:scope => "col"} Last Name:
              %th{:scope => "col"} Email
              %th{:scope => "col"} Department:
          %tbody
            %tr
              %th{:scope => "row"}
                = @ecf.user.uid

              %td= @ecf.user.givenname
              %td= @ecf.user.sn
              %td= @ecf.user.mail
              %td= @ecf.user.ou

    %h4 ECF Details
    %p
      %b Date of submission:
      = @ecf.created_at.strftime("%Y-%m-%d")

    - if current_user.id == @ecf.id
      = render "sensitive_info"
    - elsif @ecf.highly_sensitive and (can? :view_details, Ecf)
      - if current_user.role == "admin"
        %b Please note that this ECF has been marked as highly sensitive - the following details must be kept confidential.
        = render "sensitive_info"
      - else
        %b This ECF has been marked as highly sensitive - you do not have permission to view the details.
    - else
      - if can? :view_details, Ecf
        = render "sensitive_info"
      - else
        %p 
          %b You do not have permission to view the details of this form.

    %p
      %h4 Affected Units
      - if @affected_units.empty?
        .text-note
          No affected units to view.
      - else
        %table.table
          %thead
            %tr
              %th{:scope => "col"} Module Code
              %th{:scope => "col"} Assessment type
              %th{:scope => "col"} Requested Action
              %th{:scope => "col"} Affected from:
              %th{:scope => "col"} Affected to:
          %tbody
            - @affected_units.each do |affected_unit|
              %tr
                %td= affected_unit.unit_code
                %td= affected_unit.assessment_type
                %td= affected_unit.requested_action
                %td= affected_unit.date_from
                %td= affected_unit.date_to

    - if current_user.admin? or current_user.scrutiny?
      - if (@ecf.highly_sensitive and current_user.admin?) or (!@ecf.highly_sensitive)
        %h4 Uploaded Conversations:
        - if @ecf.upload_conversations.size == 0
          .text-note
            No conversations have been uploaded.
        - else
          - @ecf.upload_conversations.each do |conversation|
            %p
            = link_to conversation.filename, conversation, target: :_blank
      - else
        You do not have permission to view uploaded emails.

    - if @ecf.status == "Complete" 
      %h4 Final outcomes
      %p This ECF is marked as Complete. Please see the final decisions below.
      %table.table
        %thead
          %tr
            %th{:scope => "col"} Module Code
            %th{:scope => "col"} Assessment type
            %th{:scope => "col"} Requested Action
            %th{:scope => "col"} Outcome
            %th{:scope => "col"} Extension Date
        %tbody
          - @decisions_ecfs.each do | code, decisions |
            - decisions.each do | type, decision |
              %tr
                %td= code
                %td= decision.assessment_type
                %td= decision.requested_action
                %td= decision.outcome&.name
                - if decision.requested_action == "DEX - Deadline Extension" or decision.requested_action == "NP - No penalty for late submission"
                  %td= decision.extension_date
                - else
                  %td







